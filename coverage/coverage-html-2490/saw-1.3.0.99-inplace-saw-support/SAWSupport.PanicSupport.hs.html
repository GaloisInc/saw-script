<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE Safe #-}
<span class="lineno">    2 </span>-- |
<span class="lineno">    3 </span>-- Module      : SAWSupport.PanicSupport
<span class="lineno">    4 </span>-- License     : BSD3
<span class="lineno">    5 </span>-- Maintainer  : saw@galois.com
<span class="lineno">    6 </span>-- Stability   : provisional
<span class="lineno">    7 </span>
<span class="lineno">    8 </span>-- Wrapper around the panic library.
<span class="lineno">    9 </span>--
<span class="lineno">   10 </span>-- Each library in SAW defines its own Panic module so that panics in
<span class="lineno">   11 </span>-- it come out with the &quot;component name&quot; set to the library involved.
<span class="lineno">   12 </span>--
<span class="lineno">   13 </span>-- This module contains the shared plumbing to make those modules as
<span class="lineno">   14 </span>-- small as reasonably possible.
<span class="lineno">   15 </span>--
<span class="lineno">   16 </span>-- Panic is for internal/programming errors, not user-facing errors.
<span class="lineno">   17 </span>-- Ideally users should never see panics, and if they do see a panic
<span class="lineno">   18 </span>-- they should file a bug report about it.
<span class="lineno">   19 </span>--
<span class="lineno">   20 </span>-- Note: any uses of the Haskell &quot;error&quot; function should be converted
<span class="lineno">   21 </span>-- to use panic instead, provided they are actually panic conditions.
<span class="lineno">   22 </span>-- Any others should be updated to use proper error handling channels.
<span class="lineno">   23 </span>--
<span class="lineno">   24 </span>-- Panic is immediately fatal and may be used in pure (&quot;pure&quot;) code
<span class="lineno">   25 </span>-- when needed.
<span class="lineno">   26 </span>--
<span class="lineno">   27 </span>-- The exposed panic interface in SAW takes two arguments:
<span class="lineno">   28 </span>--    - the &quot;location of the problem&quot; (a single string)
<span class="lineno">   29 </span>--    - the &quot;problem description&quot; (a list of strings, one per line)
<span class="lineno">   30 </span>--
<span class="lineno">   31 </span>-- The infrastructure then adds the &quot;component name&quot; as well as the
<span class="lineno">   32 </span>-- Haskell module and line (via HasCallStack) and the git commit
<span class="lineno">   33 </span>-- information, and generates a print of the following form:
<span class="lineno">   34 </span>--
<span class="lineno">   35 </span>--    [18:30:30.500] You have encountered a bug in &lt;component name&gt;'s implementation.
<span class="lineno">   36 </span>--    *** Please create an issue at https://github.com/GaloisInc/saw-script/issues
<span class="lineno">   37 </span>--
<span class="lineno">   38 </span>--    %&lt; --------------------------------------------------- 
<span class="lineno">   39 </span>--      Revision:  abcd1234abcd1234cdef5678cdef5678abcd1234
<span class="lineno">   40 </span>--      Branch:    master (uncommited files present)
<span class="lineno">   41 </span>--      Location:  &lt;location of the problem&gt;
<span class="lineno">   42 </span>--      Message:   &lt;problem description&gt;
<span class="lineno">   43 </span>--                 &lt;problem description&gt;
<span class="lineno">   44 </span>--                 &lt;problem description&gt;
<span class="lineno">   45 </span>--    CallStack (from HasCallStack):
<span class="lineno">   46 </span>--      panic, called at src/SAWScript/Panic.hs:20:9 in saw-script-1.3-inplace:SAWScript.Panic
<span class="lineno">   47 </span>--      panic, called at src/SAWCentral/Proof.hs:300:15 in saw-script-1.3-inplace:SAWCentral.Proof
<span class="lineno">   48 </span>--    %&lt; ---------------------------------------------------
<span class="lineno">   49 </span>--
<span class="lineno">   50 </span>-- The arguments to each panic should be written so they make sense in
<span class="lineno">   51 </span>-- this context.
<span class="lineno">   52 </span>--
<span class="lineno">   53 </span>-- Also note that because the description lines are indented after
<span class="lineno">   54 </span>-- being unlines'd, they should not contain their own newlines.
<span class="lineno">   55 </span>--
<span class="lineno">   56 </span>-- It is reasonable to use the function name as the &quot;location of the
<span class="lineno">   57 </span>-- problem&quot;; however, it's often more helpful to use a short string
<span class="lineno">   58 </span>-- that describes what SAW was trying to do when things came unstuck.
<span class="lineno">   59 </span>--
<span class="lineno">   60 </span>-- Then, the rest of the message should indicate what happened and
<span class="lineno">   61 </span>-- also include the values of relevant variables. What gets printed
<span class="lineno">   62 </span>-- here may be all you ever get to try to figure out what broke.
<span class="lineno">   63 </span>--
<span class="lineno">   64 </span>-- It's important that the combination of the &quot;location&quot; string and
<span class="lineno">   65 </span>-- the beginning of the rest of the message should be unique.
<span class="lineno">   66 </span>--
<span class="lineno">   67 </span>-- Rationale:
<span class="lineno">   68 </span>--
<span class="lineno">   69 </span>-- In an ideal world no user would ever see a panic. However, the
<span class="lineno">   70 </span>-- reality of software is that sooner or later someone will see every
<span class="lineno">   71 </span>-- panic in the system. Furthermore, chances are that person will
<span class="lineno">   72 </span>-- probably be a downstream user, in the field. This will be someone
<span class="lineno">   73 </span>-- who has little or no familiarity with SAW's internals -- given the
<span class="lineno">   74 </span>-- nature of SAW they will probably not be a completely clueless end
<span class="lineno">   75 </span>-- user, but even so internal minutiae won't be helpful.
<span class="lineno">   76 </span>--
<span class="lineno">   77 </span>-- Therefore, that user (not the SAW developer) is the primary
<span class="lineno">   78 </span>-- audience for every panic message. Panic messages should tell the
<span class="lineno">   79 </span>-- user enough about what happened that they can try to rearrange
<span class="lineno">   80 </span>-- their stuff to avoid triggering it. They should also tell the user
<span class="lineno">   81 </span>-- enough that they have a reasonable chance at being able to cut down
<span class="lineno">   82 </span>-- whatever they're working on to something they can send upstream
<span class="lineno">   83 </span>-- with a bug report.
<span class="lineno">   84 </span>--
<span class="lineno">   85 </span>-- The SAW developer is the _secondary_ audience for every panic
<span class="lineno">   86 </span>-- message, but in general only via the bug reports that come from the
<span class="lineno">   87 </span>-- primary audience.
<span class="lineno">   88 </span>--
<span class="lineno">   89 </span>-- In most cases the function name where something blew up will not
<span class="lineno">   90 </span>-- mean much to the user seeing the panic. Hence the recommendation
<span class="lineno">   91 </span>-- for a short descriptive string instead.
<span class="lineno">   92 </span>--
<span class="lineno">   93 </span>-- The function name is also readily found via the module name, line
<span class="lineno">   94 </span>-- number, and message text. (The reason the message text needs to be
<span class="lineno">   95 </span>-- unique is that if it's not, it's easy to end up looking at the
<span class="lineno">   96 </span>-- wrong instance, despite line numbers, and then things become far
<span class="lineno">   97 </span>-- more confusing.) It's therefore not particularly important to
<span class="lineno">   98 </span>-- include it in the message if there's a better alternative.
<span class="lineno">   99 </span>--
<span class="lineno">  100 </span>-- Because panics in general get reported, not found directly by
<span class="lineno">  101 </span>-- developers, and are often hard to reproduce locally or on demand,
<span class="lineno">  102 </span>-- it's routinely necessary to diagnose and fix problems entirely or
<span class="lineno">  103 </span>-- almost entirely by analysis of the panic message and the code
<span class="lineno">  104 </span>-- around it. For this reason panics should include as much relevant
<span class="lineno">  105 </span>-- information as possible without flooding the recipient.
<span class="lineno">  106 </span>
<span class="lineno">  107 </span>-- re-export HasCallStack for use by the per-library modules
<span class="lineno">  108 </span>module SAWSupport.PanicSupport (Panic.HasCallStack, doPanic) where
<span class="lineno">  109 </span>
<span class="lineno">  110 </span>import Data.Maybe (fromMaybe)
<span class="lineno">  111 </span>import qualified Data.Text as Text
<span class="lineno">  112 </span>import Data.Text (Text)
<span class="lineno">  113 </span>import qualified Panic as Panic
<span class="lineno">  114 </span>
<span class="lineno">  115 </span>import qualified SAWVersion.GitRev as GitRev
<span class="lineno">  116 </span>
<span class="lineno">  117 </span>-- | Hook for the panic library's use. The upstream library uses types
<span class="lineno">  118 </span>--   as hooks to attach the panic metadata. We use a simpler scheme
<span class="lineno">  119 </span>--   where the metadata is implicit in which panic function you call
<span class="lineno">  120 </span>--   (at the cost of having a separate panic module in each library)
<span class="lineno">  121 </span>--   so we only need one of these.
<span class="lineno">  122 </span>--
<span class="lineno">  123 </span>--   The argument of the constructor is the component name to use
<span class="lineno">  124 </span>--   with the panic message.
<span class="lineno">  125 </span>newtype SAWPanic = SAWPanic Text
<span class="lineno">  126 </span>
<span class="lineno">  127 </span>-- | Trigger a panic. This is called by each library's panic function;
<span class="lineno">  128 </span>--   the first argument should be the component name, and the second
<span class="lineno">  129 </span>--   and third should be the &quot;location&quot; and &quot;description&quot; to pass
<span class="lineno">  130 </span>--   through to the upstream panic function.
<span class="lineno">  131 </span>doPanic :: Panic.HasCallStack =&gt; Text -&gt; Text -&gt; [Text] -&gt; a
<span class="lineno">  132 </span><span class="decl"><span class="istickedoff">doPanic component loc descs =</span>
<span class="lineno">  133 </span><span class="spaces">  </span><span class="istickedoff">Panic.panic (SAWPanic component) loc' descs'</span>
<span class="lineno">  134 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  135 </span><span class="spaces">     </span><span class="istickedoff">loc' = Text.unpack loc</span>
<span class="lineno">  136 </span><span class="spaces">     </span><span class="istickedoff">descs' = map Text.unpack descs</span></span>
<span class="lineno">  137 </span>
<span class="lineno">  138 </span>instance Panic.PanicComponent SAWPanic where
<span class="lineno">  139 </span>  <span class="decl"><span class="istickedoff">panicComponentName (SAWPanic component) = Text.unpack component</span></span>
<span class="lineno">  140 </span>  <span class="decl"><span class="istickedoff">panicComponentIssues _ = &quot;https://github.com/GaloisInc/saw-script/issues&quot;</span></span>
<span class="lineno">  141 </span>
<span class="lineno">  142 </span>  {-# Noinline panicComponentRevision #-}
<span class="lineno">  143 </span>  <span class="decl"><span class="istickedoff">panicComponentRevision _ =</span>
<span class="lineno">  144 </span><span class="spaces">    </span><span class="istickedoff">if <span class="tickonlytrue">GitRev.foundGit</span> then</span>
<span class="lineno">  145 </span><span class="spaces">        </span><span class="istickedoff">let hash = fromMaybe <span class="nottickedoff">&quot;(unknown revision)&quot;</span> GitRev.hash </span>
<span class="lineno">  146 </span><span class="spaces">            </span><span class="istickedoff">branch = fromMaybe <span class="nottickedoff">&quot;(unknown branch)&quot;</span> GitRev.branch</span>
<span class="lineno">  147 </span><span class="spaces">        </span><span class="istickedoff">in</span>
<span class="lineno">  148 </span><span class="spaces">        </span><span class="istickedoff">(hash, branch)</span>
<span class="lineno">  149 </span><span class="spaces">    </span><span class="istickedoff">else</span>
<span class="lineno">  150 </span><span class="spaces">        </span><span class="istickedoff"><span class="nottickedoff">(&quot;(VCS-less build)&quot;, &quot;(VCS-less build)&quot;)</span></span></span>

</pre>
</body>
</html>
