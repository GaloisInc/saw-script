<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{- |
<span class="lineno">    2 </span>Module      : SAWCentral.Crucible.Common
<span class="lineno">    3 </span>Description : Crucible-related material that is not specific to a given language
<span class="lineno">    4 </span>License     : BSD3
<span class="lineno">    5 </span>Maintainer  : langston
<span class="lineno">    6 </span>Stability   : provisional
<span class="lineno">    7 </span>-}
<span class="lineno">    8 </span>
<span class="lineno">    9 </span>{-# LANGUAGE ExistentialQuantification #-}
<span class="lineno">   10 </span>{-# LANGUAGE GADTs #-}
<span class="lineno">   11 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">   12 </span>{-# LANGUAGE RankNTypes #-}
<span class="lineno">   13 </span>
<span class="lineno">   14 </span>module SAWCentral.Crucible.Common
<span class="lineno">   15 </span>  ( ppAbortedResult
<span class="lineno">   16 </span>  , Sym
<span class="lineno">   17 </span>  , Backend
<span class="lineno">   18 </span>  , SomeOnlineBackend(..)
<span class="lineno">   19 </span>  , SomeBackend(..)
<span class="lineno">   20 </span>  , IsSymBackend(..)
<span class="lineno">   21 </span>  , HasSymInterface(..)
<span class="lineno">   22 </span>  , OnlineSolver(..)
<span class="lineno">   23 </span>  , PathSatSolver(..)
<span class="lineno">   24 </span>  , setupProfiling
<span class="lineno">   25 </span>  , SAWCruciblePersonality(..)
<span class="lineno">   26 </span>  , newSAWCoreExprBuilder
<span class="lineno">   27 </span>  , newSAWCoreBackend
<span class="lineno">   28 </span>  , newSAWCoreBackendWithTimeout
<span class="lineno">   29 </span>  , defaultSAWCoreBackendTimeout
<span class="lineno">   30 </span>  , sawCoreState
<span class="lineno">   31 </span>  , baseCryptolType
<span class="lineno">   32 </span>  , getGlobalPair
<span class="lineno">   33 </span>  , runCFG
<span class="lineno">   34 </span>  , typeReprToSAWTypes
<span class="lineno">   35 </span>  , termToRegValue
<span class="lineno">   36 </span>  ) where
<span class="lineno">   37 </span>
<span class="lineno">   38 </span>import qualified Cryptol.TypeCheck.Type as Cryptol
<span class="lineno">   39 </span>import qualified Lang.Crucible.CFG.Core as Crucible
<span class="lineno">   40 </span>import qualified Lang.Crucible.CFG.Extension as Crucible (IsSyntaxExtension)
<span class="lineno">   41 </span>import qualified Lang.Crucible.FunctionHandle as Crucible
<span class="lineno">   42 </span>import qualified Lang.Crucible.Simulator as Crucible
<span class="lineno">   43 </span>import           Lang.Crucible.Simulator (GenericExecutionFeature)
<span class="lineno">   44 </span>import           Lang.Crucible.Simulator.ExecutionTree (AbortedResult(..), GlobalPair)
<span class="lineno">   45 </span>import           Lang.Crucible.Simulator.CallFrame (SimFrame)
<span class="lineno">   46 </span>import           Lang.Crucible.Simulator.Profiling
<span class="lineno">   47 </span>import           Lang.Crucible.Backend
<span class="lineno">   48 </span>                   (AbortExecReason(..), ppAbortExecReason, IsSymInterface, IsSymBackend(..),
<span class="lineno">   49 </span>                    HasSymInterface(..), SomeBackend(..))
<span class="lineno">   50 </span>import           Lang.Crucible.Backend.Online (OnlineBackend, newOnlineBackend)
<span class="lineno">   51 </span>import qualified Data.Parameterized.Context as Ctx
<span class="lineno">   52 </span>import           Data.Parameterized.NatRepr (natValue)
<span class="lineno">   53 </span>import qualified Data.Parameterized.Nonce as Nonce
<span class="lineno">   54 </span>import           What4.Protocol.Online (OnlineSolver(..))
<span class="lineno">   55 </span>import qualified What4.Solver.CVC5 as CVC5
<span class="lineno">   56 </span>import qualified What4.Solver.Z3 as Z3
<span class="lineno">   57 </span>import qualified What4.Solver.Yices as Yices
<span class="lineno">   58 </span>import qualified What4.Protocol.SMTLib2 as SMT2
<span class="lineno">   59 </span>
<span class="lineno">   60 </span>import qualified What4.Config as W4
<span class="lineno">   61 </span>import qualified What4.Expr as W4
<span class="lineno">   62 </span>import qualified What4.Expr.Builder as W4
<span class="lineno">   63 </span>import qualified What4.Interface as W4
<span class="lineno">   64 </span>import qualified What4.ProgramLoc as W4 (plSourceLoc)
<span class="lineno">   65 </span>
<span class="lineno">   66 </span>import Control.Lens ( (^.) )
<span class="lineno">   67 </span>import System.Directory (createDirectoryIfMissing)
<span class="lineno">   68 </span>import System.FilePath ((&lt;/&gt;))
<span class="lineno">   69 </span>import qualified Prettyprinter as PP
<span class="lineno">   70 </span>
<span class="lineno">   71 </span>
<span class="lineno">   72 </span>import SAWCore.SharedTerm as SC
<span class="lineno">   73 </span>import SAWCoreWhat4.ReturnTrip
<span class="lineno">   74 </span>         (SAWCoreState, baseSCType, bindSAWTerm, newSAWCoreState)
<span class="lineno">   75 </span>
<span class="lineno">   76 </span>import SAWCentral.Options (Options, Verbosity(..), printOutLn)
<span class="lineno">   77 </span>
<span class="lineno">   78 </span>data PathSatSolver
<span class="lineno">   79 </span>  = PathSat_Z3
<span class="lineno">   80 </span>  | PathSat_Yices
<span class="lineno">   81 </span> deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Ord</span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Show</span></span></span></span></span></span>)
<span class="lineno">   82 </span>
<span class="lineno">   83 </span>
<span class="lineno">   84 </span>-- | The symbolic backend we use for SAW verification
<span class="lineno">   85 </span>type Sym = W4.ExprBuilder Nonce.GlobalNonceGenerator SAWCoreState (W4.Flags W4.FloatReal)
<span class="lineno">   86 </span>type Backend solver = OnlineBackend solver Nonce.GlobalNonceGenerator SAWCoreState (W4.Flags W4.FloatReal)
<span class="lineno">   87 </span>
<span class="lineno">   88 </span>data SomeOnlineBackend =
<span class="lineno">   89 </span>  forall solver. OnlineSolver solver =&gt;
<span class="lineno">   90 </span>    SomeOnlineBackend (Backend solver)
<span class="lineno">   91 </span>
<span class="lineno">   92 </span>data SAWCruciblePersonality sym = SAWCruciblePersonality
<span class="lineno">   93 </span>
<span class="lineno">   94 </span>sawCoreState :: Sym -&gt; IO (SAWCoreState Nonce.GlobalNonceGenerator)
<span class="lineno">   95 </span><span class="decl"><span class="istickedoff">sawCoreState sym = pure (sym ^. W4.userState)</span></span>
<span class="lineno">   96 </span>
<span class="lineno">   97 </span>newSAWCoreExprBuilder :: SC.SharedContext -&gt; Bool -&gt; IO Sym
<span class="lineno">   98 </span><span class="decl"><span class="istickedoff">newSAWCoreExprBuilder sc what4PushMuxOps =</span>
<span class="lineno">   99 </span><span class="spaces">  </span><span class="istickedoff">do st &lt;- newSAWCoreState sc</span>
<span class="lineno">  100 </span><span class="spaces">     </span><span class="istickedoff">sym &lt;- W4.newExprBuilder W4.FloatRealRepr st Nonce.globalNonceGenerator</span>
<span class="lineno">  101 </span><span class="spaces">     </span><span class="istickedoff">pushMuxOpsSetting &lt;- W4.getOptionSetting W4.pushMuxOpsOption $ W4.getConfiguration sym</span>
<span class="lineno">  102 </span><span class="spaces">     </span><span class="istickedoff">_ &lt;- W4.setOpt pushMuxOpsSetting what4PushMuxOps</span>
<span class="lineno">  103 </span><span class="spaces">     </span><span class="istickedoff">pure sym</span></span>
<span class="lineno">  104 </span>
<span class="lineno">  105 </span>defaultSAWCoreBackendTimeout :: Integer
<span class="lineno">  106 </span><span class="decl"><span class="istickedoff">defaultSAWCoreBackendTimeout = 10000</span></span>
<span class="lineno">  107 </span>
<span class="lineno">  108 </span>newSAWCoreBackend :: PathSatSolver -&gt; Sym -&gt; IO SomeOnlineBackend
<span class="lineno">  109 </span><span class="decl"><span class="istickedoff">newSAWCoreBackend pss sym = newSAWCoreBackendWithTimeout pss sym 0</span></span>
<span class="lineno">  110 </span>
<span class="lineno">  111 </span>newSAWCoreBackendWithTimeout :: PathSatSolver -&gt; Sym -&gt; Integer -&gt; IO SomeOnlineBackend
<span class="lineno">  112 </span><span class="decl"><span class="istickedoff">newSAWCoreBackendWithTimeout PathSat_Yices sym timeout =</span>
<span class="lineno">  113 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">do bak &lt;- newOnlineBackend sym Yices.yicesDefaultFeatures</span></span>
<span class="lineno">  114 </span><span class="spaces">     </span><span class="istickedoff"><span class="nottickedoff">W4.extendConfig Z3.z3Options (W4.getConfiguration sym)</span></span>
<span class="lineno">  115 </span><span class="spaces">     </span><span class="istickedoff"><span class="nottickedoff">W4.extendConfig Yices.yicesOptions (W4.getConfiguration sym)</span></span>
<span class="lineno">  116 </span><span class="spaces">     </span><span class="istickedoff"><span class="nottickedoff">W4.extendConfig CVC5.cvc5Options (W4.getConfiguration sym)</span></span>
<span class="lineno">  117 </span><span class="spaces">     </span><span class="istickedoff"><span class="nottickedoff">yicesTimeoutSetting &lt;- W4.getOptionSetting Yices.yicesGoalTimeout (W4.getConfiguration sym)</span></span>
<span class="lineno">  118 </span><span class="spaces">     </span><span class="istickedoff"><span class="nottickedoff">_ &lt;- W4.setOpt yicesTimeoutSetting timeout</span></span>
<span class="lineno">  119 </span><span class="spaces">     </span><span class="istickedoff"><span class="nottickedoff">return (SomeOnlineBackend (bak :: Backend Yices.Connection))</span></span>
<span class="lineno">  120 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  121 </span><span class="spaces"></span><span class="istickedoff">newSAWCoreBackendWithTimeout PathSat_Z3 sym timeout =</span>
<span class="lineno">  122 </span><span class="spaces">  </span><span class="istickedoff">do bak &lt;- newOnlineBackend sym (SMT2.defaultFeatures <span class="nottickedoff">Z3.Z3</span>)</span>
<span class="lineno">  123 </span><span class="spaces">     </span><span class="istickedoff">W4.extendConfig Z3.z3Options (W4.getConfiguration sym)</span>
<span class="lineno">  124 </span><span class="spaces">     </span><span class="istickedoff">W4.extendConfig Yices.yicesOptions (W4.getConfiguration sym)</span>
<span class="lineno">  125 </span><span class="spaces">     </span><span class="istickedoff">W4.extendConfig CVC5.cvc5Options (W4.getConfiguration sym)</span>
<span class="lineno">  126 </span><span class="spaces">     </span><span class="istickedoff">z3TimeoutSetting &lt;- W4.getOptionSetting Z3.z3Timeout (W4.getConfiguration sym)</span>
<span class="lineno">  127 </span><span class="spaces">     </span><span class="istickedoff">_ &lt;- W4.setOpt z3TimeoutSetting timeout</span>
<span class="lineno">  128 </span><span class="spaces">     </span><span class="istickedoff">return (SomeOnlineBackend (bak :: Backend (SMT2.Writer Z3.Z3)))</span></span>
<span class="lineno">  129 </span>
<span class="lineno">  130 </span>ppAbortedResult :: (forall l args. GlobalPair Sym (SimFrame Sym ext l args) -&gt; PP.Doc ann)
<span class="lineno">  131 </span>                -&gt; AbortedResult Sym ext
<span class="lineno">  132 </span>                -&gt; PP.Doc ann
<span class="lineno">  133 </span><span class="decl"><span class="istickedoff">ppAbortedResult _ (AbortedExec InfeasibleBranch{} _) =</span>
<span class="lineno">  134 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">&quot;Infeasible branch&quot;</span></span>
<span class="lineno">  135 </span><span class="spaces"></span><span class="istickedoff">ppAbortedResult ppGP (AbortedExec abt gp) = do</span>
<span class="lineno">  136 </span><span class="spaces">  </span><span class="istickedoff">PP.vcat</span>
<span class="lineno">  137 </span><span class="spaces">    </span><span class="istickedoff">[ ppAbortExecReason abt</span>
<span class="lineno">  138 </span><span class="spaces">    </span><span class="istickedoff">, ppGP gp</span>
<span class="lineno">  139 </span><span class="spaces">    </span><span class="istickedoff">]</span>
<span class="lineno">  140 </span><span class="spaces"></span><span class="istickedoff">ppAbortedResult ppGP (AbortedBranch loc _predicate trueBranch falseBranch) =</span>
<span class="lineno">  141 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">PP.vcat</span></span>
<span class="lineno">  142 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">[ &quot;Both branches aborted after a symbolic branch.&quot;</span></span>
<span class="lineno">  143 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">, &quot;Location of control-flow branching:&quot;</span></span>
<span class="lineno">  144 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">, PP.indent 2 (PP.pretty (W4.plSourceLoc loc))</span></span>
<span class="lineno">  145 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">, &quot;Message from the true branch:&quot;</span></span>
<span class="lineno">  146 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">, PP.indent 2 (ppAbortedResult ppGP trueBranch)</span></span>
<span class="lineno">  147 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">, &quot;Message from the false branch:&quot;</span></span>
<span class="lineno">  148 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">, PP.indent 2 (ppAbortedResult ppGP falseBranch)</span></span>
<span class="lineno">  149 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">]</span></span>
<span class="lineno">  150 </span><span class="spaces"></span><span class="istickedoff">ppAbortedResult _ (AbortedExit ec _gp) =</span>
<span class="lineno">  151 </span><span class="spaces">  </span><span class="istickedoff"><span class="nottickedoff">&quot;Branch exited:&quot; PP.&lt;+&gt; PP.viaShow ec</span></span></span>
<span class="lineno">  152 </span>
<span class="lineno">  153 </span>setupProfiling ::
<span class="lineno">  154 </span>  IsSymInterface sym =&gt;
<span class="lineno">  155 </span>  sym -&gt; String -&gt; Maybe FilePath -&gt;
<span class="lineno">  156 </span>  IO (IO (), [GenericExecutionFeature sym])
<span class="lineno">  157 </span><span class="decl"><span class="istickedoff">setupProfiling _ _ Nothing = return (return <span class="nottickedoff">()</span>, [])</span>
<span class="lineno">  158 </span><span class="spaces"></span><span class="istickedoff">setupProfiling sym profSource (Just dir) =</span>
<span class="lineno">  159 </span><span class="spaces">  </span><span class="istickedoff">do tbl &lt;- newProfilingTable</span>
<span class="lineno">  160 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  161 </span><span class="spaces">     </span><span class="istickedoff">createDirectoryIfMissing True dir</span>
<span class="lineno">  162 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  163 </span><span class="spaces">     </span><span class="istickedoff">startRecordingSolverEvents sym <span class="nottickedoff">tbl</span></span>
<span class="lineno">  164 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  165 </span><span class="spaces">     </span><span class="istickedoff">let profOutFile = dir &lt;/&gt; &quot;report_data.js&quot;</span>
<span class="lineno">  166 </span><span class="spaces">         </span><span class="istickedoff">saveProf = writeProfileReport profOutFile &quot;Crucible profile&quot; profSource</span>
<span class="lineno">  167 </span><span class="spaces">         </span><span class="istickedoff">profOpts = ProfilingOptions</span>
<span class="lineno">  168 </span><span class="spaces">                      </span><span class="istickedoff">{ periodicProfileInterval = 5</span>
<span class="lineno">  169 </span><span class="spaces">                      </span><span class="istickedoff">, periodicProfileAction = <span class="nottickedoff">saveProf</span></span>
<span class="lineno">  170 </span><span class="spaces">                      </span><span class="istickedoff">}</span>
<span class="lineno">  171 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  172 </span><span class="spaces">     </span><span class="istickedoff">pfs &lt;- profilingFeature tbl profilingEventFilter (Just profOpts)</span>
<span class="lineno">  173 </span><span class="spaces">     </span><span class="istickedoff">return (saveProf tbl, [pfs])</span></span>
<span class="lineno">  174 </span>
<span class="lineno">  175 </span>-- | Given a base Crucible type, compute the corresponding Cryptol type. This
<span class="lineno">  176 </span>-- should return reasonable results for most language backends, but it may not
<span class="lineno">  177 </span>-- cover everything. (For instance, MIR arrays use a custom intrinsic type,
<span class="lineno">  178 </span>-- not 'Crucible.BaseArrayRepr', so those would need to be handled separately.)
<span class="lineno">  179 </span>baseCryptolType :: Crucible.BaseTypeRepr tp -&gt; Maybe Cryptol.Type
<span class="lineno">  180 </span><span class="decl"><span class="istickedoff">baseCryptolType bt =</span>
<span class="lineno">  181 </span><span class="spaces">  </span><span class="istickedoff">case bt of</span>
<span class="lineno">  182 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseBoolRepr -&gt; pure $ Cryptol.tBit</span>
<span class="lineno">  183 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseBVRepr w -&gt; pure $ Cryptol.tWord (Cryptol.tNum (natValue w))</span>
<span class="lineno">  184 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseIntegerRepr -&gt; <span class="nottickedoff">pure $ Cryptol.tInteger</span></span>
<span class="lineno">  185 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseArrayRepr {} -&gt; <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  186 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseFloatRepr _ -&gt; <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  187 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseStringRepr _ -&gt; <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  188 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseComplexRepr  -&gt; <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  189 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseRealRepr     -&gt; <span class="nottickedoff">Nothing</span></span>
<span class="lineno">  190 </span><span class="spaces">    </span><span class="istickedoff">Crucible.BaseStructRepr ts -&gt;</span>
<span class="lineno">  191 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">Cryptol.tTuple &lt;$&gt; baseCryptolTypes ts</span></span>
<span class="lineno">  192 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  193 </span><span class="spaces">    </span><span class="istickedoff">baseCryptolTypes :: Ctx.Assignment Crucible.BaseTypeRepr args -&gt; Maybe [Cryptol.Type]</span>
<span class="lineno">  194 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">baseCryptolTypes Ctx.Empty = pure []</span></span>
<span class="lineno">  195 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">baseCryptolTypes (xs Ctx.:&gt; x) =</span></span>
<span class="lineno">  196 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">do ts &lt;- baseCryptolTypes xs</span></span>
<span class="lineno">  197 </span><span class="spaces">         </span><span class="istickedoff"><span class="nottickedoff">t &lt;- baseCryptolType x</span></span>
<span class="lineno">  198 </span><span class="spaces">         </span><span class="istickedoff"><span class="nottickedoff">pure (ts ++ [t])</span></span></span>
<span class="lineno">  199 </span>
<span class="lineno">  200 </span>getGlobalPair ::
<span class="lineno">  201 </span>  Options -&gt;
<span class="lineno">  202 </span>  Crucible.PartialResult sym ext v -&gt;
<span class="lineno">  203 </span>  IO (Crucible.GlobalPair sym v)
<span class="lineno">  204 </span><span class="decl"><span class="istickedoff">getGlobalPair opts pr =</span>
<span class="lineno">  205 </span><span class="spaces">  </span><span class="istickedoff">case pr of</span>
<span class="lineno">  206 </span><span class="spaces">    </span><span class="istickedoff">Crucible.TotalRes gp -&gt; return gp</span>
<span class="lineno">  207 </span><span class="spaces">    </span><span class="istickedoff">Crucible.PartialRes _ _ gp _ -&gt; do</span>
<span class="lineno">  208 </span><span class="spaces">      </span><span class="istickedoff">printOutLn opts Info &quot;Symbolic simulation completed with side conditions.&quot;</span>
<span class="lineno">  209 </span><span class="spaces">      </span><span class="istickedoff">return gp</span></span>
<span class="lineno">  210 </span>
<span class="lineno">  211 </span>runCFG ::
<span class="lineno">  212 </span>  (Crucible.IsSyntaxExtension ext, IsSymInterface sym) =&gt;
<span class="lineno">  213 </span>  Crucible.SimContext p sym ext -&gt;
<span class="lineno">  214 </span>  Crucible.SymGlobalState sym -&gt;
<span class="lineno">  215 </span>  Crucible.FnHandle args a -&gt;
<span class="lineno">  216 </span>  Crucible.CFG ext blocks init a -&gt;
<span class="lineno">  217 </span>  Crucible.RegMap sym init -&gt;
<span class="lineno">  218 </span>  IO (Crucible.ExecResult p sym ext (Crucible.RegEntry sym a))
<span class="lineno">  219 </span><span class="decl"><span class="istickedoff">runCFG simCtx globals h cfg args =</span>
<span class="lineno">  220 </span><span class="spaces">  </span><span class="istickedoff">do let initExecState =</span>
<span class="lineno">  221 </span><span class="spaces">           </span><span class="istickedoff">Crucible.InitialState simCtx globals Crucible.defaultAbortHandler (Crucible.handleReturnType h) $</span>
<span class="lineno">  222 </span><span class="spaces">           </span><span class="istickedoff">Crucible.runOverrideSim (Crucible.handleReturnType h)</span>
<span class="lineno">  223 </span><span class="spaces">                    </span><span class="istickedoff">(Crucible.regValue &lt;$&gt; (Crucible.callCFG cfg args))</span>
<span class="lineno">  224 </span><span class="spaces">     </span><span class="istickedoff">Crucible.executeCrucible [] initExecState</span></span>
<span class="lineno">  225 </span>
<span class="lineno">  226 </span>-- | Given a 'Crucible.TypeRepr', compute the corresponding Cryptol type
<span class="lineno">  227 </span>-- ('Cryptol.Type') and SAWCore type ('Term'). If the 'Crucible.TypeRepr' is
<span class="lineno">  228 </span>-- unsupported for extraction, throw an error message.
<span class="lineno">  229 </span>--
<span class="lineno">  230 </span>-- This is a language backend-agnostic implementation that only supports
<span class="lineno">  231 </span>-- Crucible base types. Individual language backends will want to add
<span class="lineno">  232 </span>-- additional cases on top of this function in order to support intrinsic
<span class="lineno">  233 </span>-- types.
<span class="lineno">  234 </span>typeReprToSAWTypes ::
<span class="lineno">  235 </span>  Sym -&gt;
<span class="lineno">  236 </span>  SharedContext -&gt;
<span class="lineno">  237 </span>  Crucible.TypeRepr tp -&gt;
<span class="lineno">  238 </span>  IO (Cryptol.Type, Term)
<span class="lineno">  239 </span><span class="decl"><span class="istickedoff">typeReprToSAWTypes sym sc tp =</span>
<span class="lineno">  240 </span><span class="spaces">  </span><span class="istickedoff">case Crucible.asBaseType tp of</span>
<span class="lineno">  241 </span><span class="spaces">    </span><span class="istickedoff">Crucible.AsBaseType btp -&gt; do</span>
<span class="lineno">  242 </span><span class="spaces">      </span><span class="istickedoff">cty &lt;-</span>
<span class="lineno">  243 </span><span class="spaces">        </span><span class="istickedoff">case baseCryptolType btp of</span>
<span class="lineno">  244 </span><span class="spaces">          </span><span class="istickedoff">Just cty -&gt; pure cty</span>
<span class="lineno">  245 </span><span class="spaces">          </span><span class="istickedoff">Nothing -&gt;</span>
<span class="lineno">  246 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff">fail $ unwords [&quot;Unsupported type for Crucible extraction:&quot;, show btp]</span></span>
<span class="lineno">  247 </span><span class="spaces">      </span><span class="istickedoff">scTp &lt;- baseSCType <span class="nottickedoff">sym</span> sc btp</span>
<span class="lineno">  248 </span><span class="spaces">      </span><span class="istickedoff">pure (cty, scTp)</span>
<span class="lineno">  249 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  250 </span><span class="spaces">    </span><span class="istickedoff">Crucible.NotBaseType -&gt;</span>
<span class="lineno">  251 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">fail $ unwords [&quot;Unsupported type for Crucible extraction:&quot;, show tp]</span></span></span>
<span class="lineno">  252 </span>
<span class="lineno">  253 </span>-- | Convert a fresh SAWCore 'Term' to a 'Crucible.RegValue', also binding a
<span class="lineno">  254 </span>-- fresh What4 constant and associating it to the 'Term'.
<span class="lineno">  255 </span>--
<span class="lineno">  256 </span>-- This is a language backend-agnostic implementation that only supports
<span class="lineno">  257 </span>-- Crucible base types. Individual language backends will want to add
<span class="lineno">  258 </span>-- additional cases on top of this function in order to support intrinsic
<span class="lineno">  259 </span>-- types.
<span class="lineno">  260 </span>termToRegValue ::
<span class="lineno">  261 </span>  Sym -&gt;
<span class="lineno">  262 </span>  -- | The Crucible type of the SAWCore term.
<span class="lineno">  263 </span>  Crucible.TypeRepr tp -&gt;
<span class="lineno">  264 </span>  -- | The SAWCore term.
<span class="lineno">  265 </span>  Term -&gt;
<span class="lineno">  266 </span>  IO (Crucible.RegValue Sym tp)
<span class="lineno">  267 </span><span class="decl"><span class="istickedoff">termToRegValue sym tp t =</span>
<span class="lineno">  268 </span><span class="spaces">  </span><span class="istickedoff">case Crucible.asBaseType tp of</span>
<span class="lineno">  269 </span><span class="spaces">    </span><span class="istickedoff">Crucible.AsBaseType btp -&gt; do</span>
<span class="lineno">  270 </span><span class="spaces">      </span><span class="istickedoff">st &lt;- sawCoreState sym</span>
<span class="lineno">  271 </span><span class="spaces">      </span><span class="istickedoff">bindSAWTerm sym st btp t</span>
<span class="lineno">  272 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  273 </span><span class="spaces">    </span><span class="istickedoff">Crucible.NotBaseType -&gt;</span>
<span class="lineno">  274 </span><span class="spaces">      </span><span class="istickedoff"><span class="nottickedoff">fail $ unwords [&quot;Unsupported type for Crucible extraction:&quot;, show tp]</span></span></span>

</pre>
</body>
</html>
