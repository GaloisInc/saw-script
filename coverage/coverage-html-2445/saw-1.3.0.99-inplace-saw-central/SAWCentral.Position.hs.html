<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{- |
<span class="lineno">    2 </span>Module      : SAWCentral.Position
<span class="lineno">    3 </span>Description : Positions in source code
<span class="lineno">    4 </span>Maintainer  : jhendrix, atomb
<span class="lineno">    5 </span>Stability   : provisional
<span class="lineno">    6 </span>-}
<span class="lineno">    7 </span>
<span class="lineno">    8 </span>{-# LANGUAGE DeriveDataTypeable  #-}
<span class="lineno">    9 </span>{-# LANGUAGE DeriveFunctor #-}
<span class="lineno">   10 </span>{-# LANGUAGE DeriveGeneric #-}
<span class="lineno">   11 </span>{-# LANGUAGE DeriveTraversable #-}
<span class="lineno">   12 </span>{-# LANGUAGE LambdaCase #-}
<span class="lineno">   13 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">   14 </span>{-# LANGUAGE ScopedTypeVariables #-}
<span class="lineno">   15 </span>
<span class="lineno">   16 </span>module SAWCentral.Position where
<span class="lineno">   17 </span>
<span class="lineno">   18 </span>import Control.Lens
<span class="lineno">   19 </span>import Data.Data (Data)
<span class="lineno">   20 </span>import Data.List (intercalate)
<span class="lineno">   21 </span>import GHC.Generics (Generic)
<span class="lineno">   22 </span>import System.Directory (makeRelativeToCurrentDirectory)
<span class="lineno">   23 </span>import System.FilePath (makeRelative, isAbsolute, (&lt;/&gt;), takeDirectory)
<span class="lineno">   24 </span>import qualified Data.Text as Text
<span class="lineno">   25 </span>import qualified Prettyprinter as PP
<span class="lineno">   26 </span>import qualified Prettyprinter.Render.String as PP
<span class="lineno">   27 </span>
<span class="lineno">   28 </span>import qualified What4.ProgramLoc as W4
<span class="lineno">   29 </span>import qualified What4.FunctionName as W4
<span class="lineno">   30 </span>
<span class="lineno">   31 </span>-- Pos ------------------------------------------------------------------------
<span class="lineno">   32 </span>
<span class="lineno">   33 </span>-- Type inference info, to be used to interpret the positions of
<span class="lineno">   34 </span>-- inferred types.
<span class="lineno">   35 </span>--
<span class="lineno">   36 </span>-- InfFresh means that the term (or pattern) at the given position
<span class="lineno">   37 </span>--    caused us to generate a fresh type variable, e.g. the element
<span class="lineno">   38 </span>--    type of &quot;[]&quot;.
<span class="lineno">   39 </span>-- InfTerm means that the term (or pattern) at the given position
<span class="lineno">   40 </span>--    prompted us to choose the accompanying type; e.g. &quot;[]&quot; has type
<span class="lineno">   41 </span>--    List.
<span class="lineno">   42 </span>-- InfContext means that the usage of the term at the given position
<span class="lineno">   43 </span>--    prompted us to choose the accompanying type; e.g. in &quot;f x&quot; f has
<span class="lineno">   44 </span>--    function type.
<span class="lineno">   45 </span>--
<span class="lineno">   46 </span>-- If you add an Ord instance here (there is currently no need for
<span class="lineno">   47 </span>-- one) be sure to take steps to avoid confusion with the comparison
<span class="lineno">   48 </span>-- in compareInfQuality, which is a different kind of comparison.
<span class="lineno">   49 </span>data Inference
<span class="lineno">   50 </span>  = InfFresh
<span class="lineno">   51 </span>  | InfTerm
<span class="lineno">   52 </span>  | InfContext
<span class="lineno">   53 </span>  deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Data</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>)
<span class="lineno">   54 </span>
<span class="lineno">   55 </span>-- Source position.
<span class="lineno">   56 </span>--
<span class="lineno">   57 </span>-- Mostly, this is a physical range within a file.
<span class="lineno">   58 </span>--
<span class="lineno">   59 </span>-- XXX: some logic uses Range with zero line/column numbers for end-of-file.
<span class="lineno">   60 </span>-- This should be replaced with an explicit end-of-file position.
<span class="lineno">   61 </span>--
<span class="lineno">   62 </span>-- FileOnlyPos is for both whole-file things (such as symbol tables in
<span class="lineno">   63 </span>-- executable images) and cases where we just don't have any more
<span class="lineno">   64 </span>-- detailed info.
<span class="lineno">   65 </span>--
<span class="lineno">   66 </span>-- FileAndFunctionPos is for cases where we have a function name in a
<span class="lineno">   67 </span>-- file but not a position as such (e.g. because it's compiled code
<span class="lineno">   68 </span>-- in an object file)
<span class="lineno">   69 </span>--
<span class="lineno">   70 </span>-- Internally generated objects use PosInternal with descriptive text.
<span class="lineno">   71 </span>-- (FUTURE: eliminate PosInternal in favor of explicit constructors
<span class="lineno">   72 </span>-- for the cases that currently generate PosInternal, so we can keep
<span class="lineno">   73 </span>-- track of what they are.)
<span class="lineno">   74 </span>--
<span class="lineno">   75 </span>-- PosREPL is for things typed at the repl, or in some cases (that
<span class="lineno">   76 </span>-- should get cleaned out) for things we assume came from the repl.
<span class="lineno">   77 </span>--
<span class="lineno">   78 </span>-- PosInferred is used for types generated by type inference; it
<span class="lineno">   79 </span>-- describes where and how the inference was made. This can be thought
<span class="lineno">   80 </span>-- of as the provenance of the inferred type.
<span class="lineno">   81 </span>--
<span class="lineno">   82 </span>-- If you add an Ord instance here (there is currently no need for
<span class="lineno">   83 </span>-- one) be sure to take steps to avoid confusion with the comparison
<span class="lineno">   84 </span>-- in comparePosQuality, which is a different kind of comparison.
<span class="lineno">   85 </span>--
<span class="lineno">   86 </span>-- XXX we should rearrange this so that either the usage is
<span class="lineno">   87 </span>-- &quot;import qualified SAWCentral.Position as Pos&quot; and this type is T
<span class="lineno">   88 </span>-- (so the normal name of the type is Pos.T and the constructors
<span class="lineno">   89 </span>-- are Pos.Range, Pos.Unknown, etc.) or insert Pos in the names of
<span class="lineno">   90 </span>-- all the constructors instead of just some.
<span class="lineno">   91 </span>data Pos = Range !FilePath -- file
<span class="lineno">   92 </span>                 !Int !Int -- start line, col
<span class="lineno">   93 </span>                 !Int !Int -- end line, col
<span class="lineno">   94 </span>         | FileOnlyPos !FilePath
<span class="lineno">   95 </span>         | FileAndFunctionPos !FilePath !String
<span class="lineno">   96 </span>         | Unknown
<span class="lineno">   97 </span>         | PosInternal String
<span class="lineno">   98 </span>         | PosREPL
<span class="lineno">   99 </span>         | PosInferred Inference Pos
<span class="lineno">  100 </span>  deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Data</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Generic</span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>)
<span class="lineno">  101 </span>
<span class="lineno">  102 </span>renderDoc :: PP.Doc ann -&gt; String
<span class="lineno">  103 </span><span class="decl"><span class="nottickedoff">renderDoc doc = PP.renderString (PP.layoutPretty opts doc)</span>
<span class="lineno">  104 </span><span class="spaces">  </span><span class="nottickedoff">where opts = PP.LayoutOptions (PP.AvailablePerLine 80 0.8)</span></span>
<span class="lineno">  105 </span>
<span class="lineno">  106 </span>fmtPos :: Pos -&gt; String -&gt; String
<span class="lineno">  107 </span><span class="decl"><span class="nottickedoff">fmtPos p m = show p ++ &quot;:\n&quot; ++ m'</span>
<span class="lineno">  108 </span><span class="spaces">  </span><span class="nottickedoff">where m' = intercalate &quot;\n&quot; . map (&quot;  &quot; ++) . lines $ m</span></span>
<span class="lineno">  109 </span>
<span class="lineno">  110 </span>-- Get the empty position at the beginning of the position of
<span class="lineno">  111 </span>-- something else. This can be used to provide positions for implicit
<span class="lineno">  112 </span>-- elements, such as the not-physically-present wildcard in a
<span class="lineno">  113 </span>-- do-notation binding that doesn't bind anything.
<span class="lineno">  114 </span>leadingPos :: Pos -&gt; Pos
<span class="lineno">  115 </span><span class="decl"><span class="istickedoff">leadingPos pos = case pos of</span>
<span class="lineno">  116 </span><span class="spaces">   </span><span class="istickedoff">Range f l1 c1 _l2 _c2 -&gt; Range f l1 c1 l1 c1</span>
<span class="lineno">  117 </span><span class="spaces">   </span><span class="istickedoff">_ -&gt; <span class="nottickedoff">pos</span></span></span>
<span class="lineno">  118 </span>
<span class="lineno">  119 </span>-- Paste together two positions.
<span class="lineno">  120 </span>--
<span class="lineno">  121 </span>-- Note that pasting together inferred positions isn't meaningful.
<span class="lineno">  122 </span>-- Even if the positions are from related elements, the positions will
<span class="lineno">  123 </span>-- in general be wildly different and the span between them completely
<span class="lineno">  124 </span>-- meaningless.
<span class="lineno">  125 </span>--
<span class="lineno">  126 </span>-- I'm hesitant to make the inferred position cases crash, though.
<span class="lineno">  127 </span>-- Maybe in the FUTURE when we can have more faith that we won't
<span class="lineno">  128 </span>-- accidentally trigger them on some random code path. Or maybe we
<span class="lineno">  129 </span>-- should statically rule them out by having multiple layers of
<span class="lineno">  130 </span>-- position type. (If we do that, maybe pasting PosInternal should
<span class="lineno">  131 </span>-- also be disallowed.)  For now, just arbitrarily pick one and
<span class="lineno">  132 </span>-- discard the other. Note that inferred positions are only generated
<span class="lineno">  133 </span>-- by typechecking and thus only appear there and downstream, and
<span class="lineno">  134 </span>-- nearly but not quite all the position-pasting happens in the parser
<span class="lineno">  135 </span>-- upstream of that.
<span class="lineno">  136 </span>--
<span class="lineno">  137 </span>-- If we mix an inferred position and a real one, just use the real one.
<span class="lineno">  138 </span>--
<span class="lineno">  139 </span>-- Similar considerations arise from pasting FileOnlyPos and
<span class="lineno">  140 </span>-- FileAndFunctionPos. These should also only appear downstream of the
<span class="lineno">  141 </span>-- saw-script parser.
<span class="lineno">  142 </span>spanPos :: Pos -&gt; Pos -&gt; Pos
<span class="lineno">  143 </span>-- prefer internal and REPL to anything else
<span class="lineno">  144 </span><span class="decl"><span class="istickedoff">spanPos (PosInternal str) _ = <span class="nottickedoff">PosInternal str</span></span>
<span class="lineno">  145 </span><span class="spaces"></span><span class="istickedoff">spanPos PosREPL _ = <span class="nottickedoff">PosREPL</span></span>
<span class="lineno">  146 </span><span class="spaces"></span><span class="istickedoff">spanPos _ (PosInternal str) = <span class="nottickedoff">PosInternal str</span></span>
<span class="lineno">  147 </span><span class="spaces"></span><span class="istickedoff">spanPos _ PosREPL = <span class="nottickedoff">PosREPL</span></span>
<span class="lineno">  148 </span><span class="spaces"></span><span class="istickedoff">-- prefer anything else to unknown</span>
<span class="lineno">  149 </span><span class="spaces"></span><span class="istickedoff">spanPos Unknown p = p</span>
<span class="lineno">  150 </span><span class="spaces"></span><span class="istickedoff">spanPos p Unknown = p</span>
<span class="lineno">  151 </span><span class="spaces"></span><span class="istickedoff">-- if it's the same file, keep it; otherwise give up</span>
<span class="lineno">  152 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileOnlyPos f) (FileOnlyPos f') | <span class="nottickedoff">f == f'</span> = <span class="nottickedoff">FileOnlyPos f</span></span>
<span class="lineno">  153 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileOnlyPos _) (FileOnlyPos _) = <span class="nottickedoff">Unknown</span></span>
<span class="lineno">  154 </span><span class="spaces"></span><span class="istickedoff">-- if it's the same file and same function, keep it; otherwise if it's the</span>
<span class="lineno">  155 </span><span class="spaces"></span><span class="istickedoff">-- same file drop the function; otherwise give up</span>
<span class="lineno">  156 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileAndFunctionPos f fn) (FileAndFunctionPos f' fn') | <span class="nottickedoff">f == f' &amp;&amp; fn == fn'</span> =</span>
<span class="lineno">  157 </span><span class="spaces">   </span><span class="istickedoff"><span class="nottickedoff">FileAndFunctionPos f fn</span></span>
<span class="lineno">  158 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileAndFunctionPos f _) (FileAndFunctionPos f' _) | <span class="nottickedoff">f == f'</span> = <span class="nottickedoff">FileOnlyPos f</span></span>
<span class="lineno">  159 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileAndFunctionPos _ _) (FileAndFunctionPos _ _) = <span class="nottickedoff">Unknown</span></span>
<span class="lineno">  160 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileOnlyPos f) (FileAndFunctionPos f' _) | <span class="nottickedoff">f == f'</span> = <span class="nottickedoff">FileOnlyPos f</span></span>
<span class="lineno">  161 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileAndFunctionPos f _) (FileOnlyPos f') | <span class="nottickedoff">f == f'</span> = <span class="nottickedoff">FileOnlyPos f</span></span>
<span class="lineno">  162 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileOnlyPos _) (FileAndFunctionPos _ _) = <span class="nottickedoff">Unknown</span></span>
<span class="lineno">  163 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileAndFunctionPos _ _) (FileOnlyPos _) = <span class="nottickedoff">Unknown</span></span>
<span class="lineno">  164 </span><span class="spaces"></span><span class="istickedoff">-- these cases should really not arise</span>
<span class="lineno">  165 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileOnlyPos _) p = <span class="nottickedoff">p</span></span>
<span class="lineno">  166 </span><span class="spaces"></span><span class="istickedoff">spanPos p (FileOnlyPos _) = <span class="nottickedoff">p</span></span>
<span class="lineno">  167 </span><span class="spaces"></span><span class="istickedoff">spanPos (FileAndFunctionPos _ _) p = <span class="nottickedoff">p</span></span>
<span class="lineno">  168 </span><span class="spaces"></span><span class="istickedoff">spanPos p (FileAndFunctionPos _ _) = <span class="nottickedoff">p</span></span>
<span class="lineno">  169 </span><span class="spaces"></span><span class="istickedoff">-- for two inferred positions arbitrarily choose the left one;</span>
<span class="lineno">  170 </span><span class="spaces"></span><span class="istickedoff">-- otherwise defer to the real position</span>
<span class="lineno">  171 </span><span class="spaces"></span><span class="istickedoff">spanPos p@(PosInferred _ _) (PosInferred _ _) = <span class="nottickedoff">p</span></span>
<span class="lineno">  172 </span><span class="spaces"></span><span class="istickedoff">spanPos (PosInferred _ _) p = <span class="nottickedoff">p</span></span>
<span class="lineno">  173 </span><span class="spaces"></span><span class="istickedoff">spanPos p (PosInferred _ _) = <span class="nottickedoff">p</span></span>
<span class="lineno">  174 </span><span class="spaces"></span><span class="istickedoff">spanPos (Range f sl sc el ec) (Range _ sl' sc' el' ec') =  Range f l c l' c'</span>
<span class="lineno">  175 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  176 </span><span class="spaces">    </span><span class="istickedoff">(l, c) = minPos sl sc sl' sc'</span>
<span class="lineno">  177 </span><span class="spaces">    </span><span class="istickedoff">(l', c') = maxPos el ec el' ec'</span>
<span class="lineno">  178 </span><span class="spaces">    </span><span class="istickedoff">minPos l1 c1 l2 c2 | l1 &lt; l2   = (l1, c1)</span>
<span class="lineno">  179 </span><span class="spaces">                       </span><span class="istickedoff">| <span class="tickonlytrue">l1 == l2</span>  = (l1, min c1 c2)</span>
<span class="lineno">  180 </span><span class="spaces">                       </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> = <span class="nottickedoff">(l2, c2)</span></span>
<span class="lineno">  181 </span><span class="spaces">    </span><span class="istickedoff">maxPos l1 c1 l2 c2 | l1 &lt; l2   = (l2, c2)</span>
<span class="lineno">  182 </span><span class="spaces">                       </span><span class="istickedoff">| <span class="tickonlytrue">l1 == l2</span>  = (l1, max c1 c2)</span>
<span class="lineno">  183 </span><span class="spaces">                       </span><span class="istickedoff">| <span class="nottickedoff">otherwise</span> = <span class="nottickedoff">(l1, c1)</span></span></span>
<span class="lineno">  184 </span>
<span class="lineno">  185 </span>-- Compare two type inference notes for quality of information, as per
<span class="lineno">  186 </span>-- comparePosQuality below. InfFresh is less, others are equal.
<span class="lineno">  187 </span>compareInfQuality :: Inference -&gt; Inference -&gt; Ordering
<span class="lineno">  188 </span><span class="decl"><span class="nottickedoff">compareInfQuality inf1 inf2 = case (inf1, inf2) of</span>
<span class="lineno">  189 </span><span class="spaces">  </span><span class="nottickedoff">(InfFresh, InfFresh) -&gt; EQ</span>
<span class="lineno">  190 </span><span class="spaces">  </span><span class="nottickedoff">(InfFresh, _) -&gt; LT</span>
<span class="lineno">  191 </span><span class="spaces">  </span><span class="nottickedoff">(_, InfFresh) -&gt; GT</span>
<span class="lineno">  192 </span><span class="spaces">  </span><span class="nottickedoff">_ -&gt; EQ</span></span>
<span class="lineno">  193 </span>
<span class="lineno">  194 </span>-- Compare two positions for the same thing (e.g. two types we just
<span class="lineno">  195 </span>-- unified), choosing the one with higher quality information. Use the
<span class="lineno">  196 </span>-- following heuristics:
<span class="lineno">  197 </span>--    - obviously prefer any concrete position to a placeholder
<span class="lineno">  198 </span>--    - PosREPL is a better placeholder than Unknown
<span class="lineno">  199 </span>--    - prefer the position with the smaller span, as it's likely
<span class="lineno">  200 </span>--      to be more precise
<span class="lineno">  201 </span>--    - when all else fails call them equal
<span class="lineno">  202 </span>--
<span class="lineno">  203 </span>-- This could be an Ord instance but it seems dangerous to use it
<span class="lineno">  204 </span>-- implicitly since an EQ result doesn't imply actual equality.
<span class="lineno">  205 </span>--
<span class="lineno">  206 </span>-- This is split out from choosePos so it'll be compositional if we
<span class="lineno">  207 </span>-- end up with more stratification of position types.
<span class="lineno">  208 </span>comparePosQuality :: Pos -&gt; Pos -&gt; Ordering
<span class="lineno">  209 </span><span class="decl"><span class="nottickedoff">comparePosQuality p1 p2 = case (p1, p2) of</span>
<span class="lineno">  210 </span><span class="spaces">   </span><span class="nottickedoff">(Unknown, Unknown) -&gt; EQ</span>
<span class="lineno">  211 </span><span class="spaces">   </span><span class="nottickedoff">(Unknown, _) -&gt; LT</span>
<span class="lineno">  212 </span><span class="spaces">   </span><span class="nottickedoff">(_, Unknown) -&gt; GT</span>
<span class="lineno">  213 </span><span class="spaces">   </span><span class="nottickedoff">(PosREPL, PosREPL) -&gt; EQ</span>
<span class="lineno">  214 </span><span class="spaces">   </span><span class="nottickedoff">(PosREPL, _) -&gt; LT</span>
<span class="lineno">  215 </span><span class="spaces">   </span><span class="nottickedoff">(_, PosREPL) -&gt; GT</span>
<span class="lineno">  216 </span><span class="spaces">   </span><span class="nottickedoff">(PosInternal _, PosInternal _) -&gt; EQ</span>
<span class="lineno">  217 </span><span class="spaces">   </span><span class="nottickedoff">(PosInternal _, _) -&gt; LT</span>
<span class="lineno">  218 </span><span class="spaces">   </span><span class="nottickedoff">(_, PosInternal _) -&gt; GT</span>
<span class="lineno">  219 </span><span class="spaces">   </span><span class="nottickedoff">(FileOnlyPos _, FileOnlyPos _) -&gt; EQ</span>
<span class="lineno">  220 </span><span class="spaces">   </span><span class="nottickedoff">(FileOnlyPos _, FileAndFunctionPos _ _) -&gt; LT</span>
<span class="lineno">  221 </span><span class="spaces">   </span><span class="nottickedoff">(FileAndFunctionPos _ _, FileOnlyPos _) -&gt; GT</span>
<span class="lineno">  222 </span><span class="spaces">   </span><span class="nottickedoff">(FileAndFunctionPos _ _, FileAndFunctionPos _ _) -&gt; EQ</span>
<span class="lineno">  223 </span><span class="spaces">   </span><span class="nottickedoff">(FileOnlyPos _, _) -&gt; LT</span>
<span class="lineno">  224 </span><span class="spaces">   </span><span class="nottickedoff">(_, FileOnlyPos _) -&gt; GT</span>
<span class="lineno">  225 </span><span class="spaces">   </span><span class="nottickedoff">(FileAndFunctionPos _ _, _) -&gt; LT</span>
<span class="lineno">  226 </span><span class="spaces">   </span><span class="nottickedoff">(_, FileAndFunctionPos _ _) -&gt; GT</span>
<span class="lineno">  227 </span><span class="spaces">   </span><span class="nottickedoff">(PosInferred inf1 p1', PosInferred inf2 p2') -&gt;</span>
<span class="lineno">  228 </span><span class="spaces">     </span><span class="nottickedoff">case compareInfQuality inf1 inf2 of</span>
<span class="lineno">  229 </span><span class="spaces">       </span><span class="nottickedoff">EQ -&gt; comparePosQuality p1' p2'</span>
<span class="lineno">  230 </span><span class="spaces">       </span><span class="nottickedoff">LT -&gt; LT</span>
<span class="lineno">  231 </span><span class="spaces">       </span><span class="nottickedoff">GT -&gt; GT</span>
<span class="lineno">  232 </span><span class="spaces">   </span><span class="nottickedoff">(PosInferred _ _, _) -&gt; LT</span>
<span class="lineno">  233 </span><span class="spaces">   </span><span class="nottickedoff">(_, PosInferred _ _) -&gt; GT</span>
<span class="lineno">  234 </span><span class="spaces">   </span><span class="nottickedoff">(Range _ sl1 _ el1 _, Range _ sl2 _ el2 _) | el2 - sl2 &lt; el1 - sl1 -&gt; LT</span>
<span class="lineno">  235 </span><span class="spaces">   </span><span class="nottickedoff">(Range _ sl1 _ el1 _, Range _ sl2 _ el2 _) | el1 - sl1 &lt; el2 - sl2 -&gt; GT</span>
<span class="lineno">  236 </span><span class="spaces">   </span><span class="nottickedoff">(Range _ _ sc1 _ ec1, Range _ _ sc2 _ ec2) | ec2 - sc2 &lt; ec1 - sc1 -&gt; LT</span>
<span class="lineno">  237 </span><span class="spaces">   </span><span class="nottickedoff">(Range _ _ sc1 _ ec1, Range _ _ sc2 _ ec2) | ec1 - sc1 &lt; ec2 - sc2 -&gt; GT</span>
<span class="lineno">  238 </span><span class="spaces">   </span><span class="nottickedoff">(Range _ _ _ _ _, Range _ _ _ _ _) -&gt; EQ</span></span>
<span class="lineno">  239 </span>
<span class="lineno">  240 </span>-- Pick the better position to use going forward. If all else fails
<span class="lineno">  241 </span>-- pick the left one.
<span class="lineno">  242 </span>choosePos :: Pos -&gt; Pos -&gt; Pos
<span class="lineno">  243 </span><span class="decl"><span class="nottickedoff">choosePos p1 p2 = case comparePosQuality p1 p2 of</span>
<span class="lineno">  244 </span><span class="spaces">   </span><span class="nottickedoff">LT -&gt; p2</span>
<span class="lineno">  245 </span><span class="spaces">   </span><span class="nottickedoff">GT -&gt; p1</span>
<span class="lineno">  246 </span><span class="spaces">   </span><span class="nottickedoff">EQ -&gt; p1</span></span>
<span class="lineno">  247 </span>
<span class="lineno">  248 </span>fmtPoss :: [Pos] -&gt; String -&gt; String
<span class="lineno">  249 </span><span class="decl"><span class="nottickedoff">fmtPoss [] m = fmtPos (PosInternal &quot;saw-script internal&quot;) m</span>
<span class="lineno">  250 </span><span class="spaces"></span><span class="nottickedoff">fmtPoss ps m = &quot;[&quot; ++ intercalate &quot;,\n &quot; (map show ps) ++ &quot;]:\n&quot; ++ m'</span>
<span class="lineno">  251 </span><span class="spaces">  </span><span class="nottickedoff">where m' = intercalate &quot;\n&quot; . map (&quot;  &quot; ++) . lines $ m</span></span>
<span class="lineno">  252 </span>
<span class="lineno">  253 </span>posRelativeToCurrentDirectory :: Pos -&gt; IO Pos
<span class="lineno">  254 </span><span class="decl"><span class="nottickedoff">posRelativeToCurrentDirectory (Range f sl sc el ec) = makeRelativeToCurrentDirectory f &gt;&gt;= \f' -&gt; return (Range f' sl sc el ec)</span>
<span class="lineno">  255 </span><span class="spaces"></span><span class="nottickedoff">posRelativeToCurrentDirectory (FileOnlyPos f)       = makeRelativeToCurrentDirectory f &gt;&gt;= \f' -&gt; return (FileOnlyPos f')</span>
<span class="lineno">  256 </span><span class="spaces"></span><span class="nottickedoff">posRelativeToCurrentDirectory (FileAndFunctionPos f fn) = makeRelativeToCurrentDirectory f &gt;&gt;= \f' -&gt; return (FileAndFunctionPos f' fn)</span>
<span class="lineno">  257 </span><span class="spaces"></span><span class="nottickedoff">posRelativeToCurrentDirectory Unknown               = return Unknown</span>
<span class="lineno">  258 </span><span class="spaces"></span><span class="nottickedoff">posRelativeToCurrentDirectory (PosInternal s)       = return $ PosInternal s</span>
<span class="lineno">  259 </span><span class="spaces"></span><span class="nottickedoff">posRelativeToCurrentDirectory PosREPL               = return PosREPL</span>
<span class="lineno">  260 </span><span class="spaces"></span><span class="nottickedoff">posRelativeToCurrentDirectory (PosInferred inf p) =</span>
<span class="lineno">  261 </span><span class="spaces">  </span><span class="nottickedoff">PosInferred inf &lt;$&gt; posRelativeToCurrentDirectory p</span></span>
<span class="lineno">  262 </span>
<span class="lineno">  263 </span>posRelativeTo :: FilePath -&gt; Pos -&gt; Pos
<span class="lineno">  264 </span><span class="decl"><span class="nottickedoff">posRelativeTo d (Range f sl sc el ec) = Range (makeRelative d f) sl sc el ec</span>
<span class="lineno">  265 </span><span class="spaces"></span><span class="nottickedoff">posRelativeTo d (FileOnlyPos f)       = FileOnlyPos (makeRelative d f)</span>
<span class="lineno">  266 </span><span class="spaces"></span><span class="nottickedoff">posRelativeTo d (FileAndFunctionPos f fn) = FileAndFunctionPos (makeRelative d f) fn</span>
<span class="lineno">  267 </span><span class="spaces"></span><span class="nottickedoff">posRelativeTo _ Unknown               = Unknown</span>
<span class="lineno">  268 </span><span class="spaces"></span><span class="nottickedoff">posRelativeTo _ (PosInternal s)       = PosInternal s</span>
<span class="lineno">  269 </span><span class="spaces"></span><span class="nottickedoff">posRelativeTo _ PosREPL               = PosREPL</span>
<span class="lineno">  270 </span><span class="spaces"></span><span class="nottickedoff">posRelativeTo d (PosInferred inf p)   = PosInferred inf $ posRelativeTo d p</span></span>
<span class="lineno">  271 </span>
<span class="lineno">  272 </span>routePathThroughPos :: Pos -&gt; FilePath -&gt; FilePath
<span class="lineno">  273 </span><span class="decl"><span class="nottickedoff">routePathThroughPos pos fp</span>
<span class="lineno">  274 </span><span class="spaces">  </span><span class="nottickedoff">| isAbsolute fp = fp</span>
<span class="lineno">  275 </span><span class="spaces">  </span><span class="nottickedoff">| True = case pos of</span>
<span class="lineno">  276 </span><span class="spaces">        </span><span class="nottickedoff">Range f _ _ _ _        -&gt; takeDirectory f &lt;/&gt; fp</span>
<span class="lineno">  277 </span><span class="spaces">        </span><span class="nottickedoff">FileOnlyPos f          -&gt; takeDirectory f &lt;/&gt; fp</span>
<span class="lineno">  278 </span><span class="spaces">        </span><span class="nottickedoff">FileAndFunctionPos f _ -&gt; takeDirectory f &lt;/&gt; fp</span>
<span class="lineno">  279 </span><span class="spaces">        </span><span class="nottickedoff">PosInferred _inf pos'  -&gt; routePathThroughPos pos' fp</span>
<span class="lineno">  280 </span><span class="spaces">        </span><span class="nottickedoff">_ -&gt; fp</span></span>
<span class="lineno">  281 </span>
<span class="lineno">  282 </span>-- Show instance for positions.
<span class="lineno">  283 </span>--
<span class="lineno">  284 </span>-- XXX: while this is adequate for basic positions, printing the
<span class="lineno">  285 </span>-- position information for inferred types is more complicated.  Most
<span class="lineno">  286 </span>-- likely, the inference information should be its own message rather
<span class="lineno">  287 </span>-- than being stuffed into the position field of some other message.
<span class="lineno">  288 </span>-- It remains to be seen exactly how that ought to work, so for now
<span class="lineno">  289 </span>-- just stuff things into the Show instance. It's possible that later
<span class="lineno">  290 </span>-- on this Show instance should be withdrawn in favor of more specific
<span class="lineno">  291 </span>-- tools. Note that because of limitations of Haskell we can't really
<span class="lineno">  292 </span>-- provide a centralized error-reporting facility, but we can at least
<span class="lineno">  293 </span>-- expect code that converts errors to lists of output lines to come
<span class="lineno">  294 </span>-- through code in this module and not be calling show on positions
<span class="lineno">  295 </span>-- itself.
<span class="lineno">  296 </span>instance <span class="decl"><span class="istickedoff"><span class="decl"><span class="nottickedoff">Show Pos</span></span></span></span> where
<span class="lineno">  297 </span>  -- show (Pos f 0 0)           = f ++ &quot;:end-of-file&quot;
<span class="lineno">  298 </span>  -- show (Pos f l c)           = f ++ &quot;:&quot; ++ show l ++ &quot;:&quot; ++ show c
<span class="lineno">  299 </span>  <span class="decl"><span class="istickedoff">show (Range f 0 0 0 0) = <span class="nottickedoff">f ++ &quot;:end-of-file&quot;</span></span>
<span class="lineno">  300 </span><span class="spaces">  </span><span class="istickedoff">show (Range f sl sc el ec) = f ++ &quot;:&quot; ++ show sl ++ &quot;:&quot; ++ show sc ++ &quot;-&quot; ++ show el ++ &quot;:&quot; ++ show ec</span>
<span class="lineno">  301 </span><span class="spaces">  </span><span class="istickedoff">show (FileOnlyPos f)          = <span class="nottickedoff">f</span></span>
<span class="lineno">  302 </span><span class="spaces">  </span><span class="istickedoff">show (FileAndFunctionPos f fn)  = <span class="nottickedoff">f ++ &quot;:&quot; ++ fn</span></span>
<span class="lineno">  303 </span><span class="spaces">  </span><span class="istickedoff">show (PosInferred InfFresh p)   = show p ++ &quot;: Fresh type for this term&quot;</span>
<span class="lineno">  304 </span><span class="spaces">  </span><span class="istickedoff">show (PosInferred InfTerm p)    = <span class="nottickedoff">show p ++ &quot;: Inferred from this term&quot;</span></span>
<span class="lineno">  305 </span><span class="spaces">  </span><span class="istickedoff">show (PosInferred InfContext p) = <span class="nottickedoff">show p ++ &quot;: Inferred from this context&quot;</span></span>
<span class="lineno">  306 </span><span class="spaces">  </span><span class="istickedoff">show Unknown               = <span class="nottickedoff">&quot;unknown&quot;</span></span>
<span class="lineno">  307 </span><span class="spaces">  </span><span class="istickedoff">show (PosInternal s)       = <span class="nottickedoff">&quot;[internal:&quot; ++ s ++ &quot;]&quot;</span></span>
<span class="lineno">  308 </span><span class="spaces">  </span><span class="istickedoff">show PosREPL               = <span class="nottickedoff">&quot;REPL&quot;</span></span></span>
<span class="lineno">  309 </span>
<span class="lineno">  310 </span>toW4Loc :: Text.Text -&gt; Pos -&gt; W4.ProgramLoc
<span class="lineno">  311 </span><span class="decl"><span class="istickedoff">toW4Loc fnm =</span>
<span class="lineno">  312 </span><span class="spaces">  </span><span class="istickedoff">\case</span>
<span class="lineno">  313 </span><span class="spaces">    </span><span class="istickedoff">FileOnlyPos f -&gt; <span class="nottickedoff">mkLoc (fnm &lt;&gt; &quot; &quot; &lt;&gt; Text.pack f) W4.InternalPos</span></span>
<span class="lineno">  314 </span><span class="spaces">    </span><span class="istickedoff">FileAndFunctionPos f fn -&gt; <span class="nottickedoff">mkLoc (fnm &lt;&gt; &quot; &quot; &lt;&gt; Text.pack f &lt;&gt; &quot; &quot; &lt;&gt; Text.pack fn) W4.InternalPos</span></span>
<span class="lineno">  315 </span><span class="spaces">    </span><span class="istickedoff">Unknown -&gt; <span class="nottickedoff">mkLoc fnm W4.InternalPos</span></span>
<span class="lineno">  316 </span><span class="spaces">    </span><span class="istickedoff">PosREPL -&gt; <span class="nottickedoff">mkLoc (fnm &lt;&gt; &quot; &lt;REPL&gt;&quot;) W4.InternalPos</span></span>
<span class="lineno">  317 </span><span class="spaces">    </span><span class="istickedoff">PosInternal nm -&gt; mkLoc (fnm &lt;&gt; &quot; &quot; &lt;&gt; Text.pack nm) W4.InternalPos</span>
<span class="lineno">  318 </span><span class="spaces">    </span><span class="istickedoff">PosInferred _ p -&gt; <span class="nottickedoff">toW4Loc fnm p</span></span>
<span class="lineno">  319 </span><span class="spaces">    </span><span class="istickedoff">Range file sl sc _el _ec -&gt;</span>
<span class="lineno">  320 </span><span class="spaces">      </span><span class="istickedoff">mkLoc fnm (W4.SourcePos (Text.pack file) sl sc)</span>
<span class="lineno">  321 </span><span class="spaces">  </span><span class="istickedoff">where mkLoc nm = W4.mkProgramLoc (W4.functionNameFromText nm)</span></span>
<span class="lineno">  322 </span>
<span class="lineno">  323 </span>-- Positioned -----------------------------------------------------------------
<span class="lineno">  324 </span>
<span class="lineno">  325 </span>class Positioned a where
<span class="lineno">  326 </span>  getPos :: a -&gt; Pos
<span class="lineno">  327 </span>
<span class="lineno">  328 </span>instance Positioned Pos where
<span class="lineno">  329 </span>  <span class="decl"><span class="istickedoff">getPos p = p</span></span>
<span class="lineno">  330 </span>
<span class="lineno">  331 </span>-- Caution: if you write maxSpan (a, b) for heterogeneous types a and b,
<span class="lineno">  332 </span>-- it will typecheck but not actually work correctly. Either call getPos
<span class="lineno">  333 </span>-- first or use maxSpan' for this case.
<span class="lineno">  334 </span>maxSpan :: (Functor t, Foldable t, Positioned a) =&gt; t a -&gt; Pos
<span class="lineno">  335 </span><span class="decl"><span class="istickedoff">maxSpan xs = foldr spanPos Unknown (fmap getPos xs)</span></span>
<span class="lineno">  336 </span>
<span class="lineno">  337 </span>maxSpan' :: (Positioned a, Positioned b) =&gt; a -&gt; b -&gt; Pos
<span class="lineno">  338 </span><span class="decl"><span class="istickedoff">maxSpan' x y = spanPos (getPos x) (getPos y)</span></span>
<span class="lineno">  339 </span>
<span class="lineno">  340 </span>-- WithPos -----------------------------------------------------------------
<span class="lineno">  341 </span>
<span class="lineno">  342 </span>data WithPos a = WithPos { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">_wpPos</span></span></span> :: Pos, <span class="nottickedoff"><span class="decl"><span class="nottickedoff">_wpVal</span></span></span> :: a }
<span class="lineno">  343 </span>  deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Data</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Functor</span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Foldable</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Generic</span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Show</span></span></span></span></span></span>, <span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Traversable</span></span></span></span></span></span></span></span>)
<span class="lineno">  344 </span>
<span class="lineno">  345 </span>wpPos :: Simple Lens (WithPos a) Pos
<span class="lineno">  346 </span><span class="decl"><span class="nottickedoff">wpPos = lens _wpPos (\s v -&gt; s { _wpPos = v })</span></span>
<span class="lineno">  347 </span>
<span class="lineno">  348 </span>wpVal :: Simple Lens (WithPos a) a
<span class="lineno">  349 </span><span class="decl"><span class="nottickedoff">wpVal = lens _wpVal (\s v -&gt; s { _wpVal = v })</span></span>
<span class="lineno">  350 </span>
<span class="lineno">  351 </span>instance Positioned (WithPos a) where
<span class="lineno">  352 </span>  <span class="decl"><span class="nottickedoff">getPos = view wpPos</span></span>

</pre>
</body>
</html>
