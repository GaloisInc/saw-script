# Overview

This repository contains a backend for the `saw-core` library that outputs terms
in the syntax of Rocq. The Rocq files generated by this backend depend on the Rocq
support libraries described below, which must be compiled in Rocq in order to be
used.


# The Rocq Support Libraries

The Rocq files that are generated by the `saw-core-rocq` backend rely on a number
of support libraries, some of which are generated from the SAW core prelude
files and some of which are hand-written extensions of those libraries. These
support libraries must be compiled by Rocq in order to use them.


## Installing Dependencies

To compile the Rocq support libraries, Rocq must be installed, as must the
following library:

* [coq-bits](https://github.com/rocq-community/bits)

The recommended way to install Rocq and these dependencies is using `opam`. This
can be done with the following steps, which will not only install `opam`, Rocq, and
the above mentioned Rocq libraries, but will make sure to install the proper
version of Rocq needed for those libraries.

To install `opam` and Rocq:
```
sh <(curl -sL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh)
opam init
opam pin add rocq-prover 9.0.0
opam install rocq-core=9.1.0 rocq-stdlib=9.0.0
opam repo add rocq-released https://rocq-prover.org/opam/released
```

Installing the required version of `coq-bits` (linked above) also requires
installing the `coq` package, which includes compatibility shims to support the
Coq to Rocq transition (e.g. the `coqc` and `coq_makefile` executables):
```
opam install coq=9.1.0
opam pin coq-bits https://github.com/rocq-community/bits.git#f50fc3e5f1eabcb0b0b94c8d25f75e61a255c2ba
```

If you run into any issue that is probably due to the version mismatch between the `ocamlc`
and the `ocaml` base system installed on your machine and it can be fixed as explained
[here](https://github.com/ocaml/opam/issues/3708).

Currently, the Rocq support libraries for `saw-core-rocq` require `rocq-core`
version `9.1.0` and `rocq-stdlib` version `9.0.0`.

## Building the and Using the Rocq Support Libraries

The `rocq/` directory contains the Rocq support libraries for the `saw-core-rocq`
backend, as well as a number of example Rocq files that have been generated from
existing SAW proofs. In order to build just the Rocq support libraries, the
following commands can be used:

```
cd rocq
make generated/CryptolToRocq/SAWCorePrelude.vo
```

To use these libraries, the following lines can be added to a `_RocqProject`
file, where PATH_TO_SAW is replaced by the path to the `saw-script` directory:

```
-Q PATH_TO_SAW/saw-core-rocq/rocq/generated/CryptolToRocq     CryptolToRocq
-Q PATH_TO_SAW/saw-core-rocq/rocq/handwritten/CryptolToRocq   CryptolToRocq
```


## Generating the Rocq Support Libraries

The Rocq support libraries can be re-generated from their SAWCore/Cryptol
counterparts if these modules change.  This can be done in the `saw/` directory,
by running the scripts there with an appropriate version of the `saw`
executable.  The output of such files are currently being version-controlled, as
a way of keeping track of their evolution.

```
/path/to/saw generate_scaffolding.saw
```


# Directory Structure

* `rocq/` contains handwritten Rocq files in `handwritten/` and generated ones in
  `generated/`, as well as some files needed to build the Rocq files.

* `cryptol/` contains some Cryptol files that we care about extracting.

* `saw/` contains SAW scripts that generate the Rocq files.


## Rocq Files Organization

The Rocq files have a somewhat complex organization.  We demonstrate the current
dependencies, ignoring transitive dependencies for clarity:

```
                      SAWCoreScaffolding (H)
                          /           \
SAWCoreVectorsAsRocqVectors (H)   SAWCoreVectorsAsRocqLists (H)
                          \           /
  RocqVectorsExtra (H)    SAWCorePrelude (G)
             \            /            \
   CryptolPrimitivesForSAWCore (G)     SAWCorePreludeExtra (H)
                         \               /
               CryptolPrimitivesForSAWCoreExtra (H)

```

(G) stands for generated files, while (H) stands for handwritten files.

* `SAWCoreScaffolding` defines some of SAW core primitive types and values.

* `SAWCoreVectorsAsRocqVectors` and `SAWCoreVectorsAsRocqLists` are two
  realizations of the vector type, the latter ignoring the type index. In
  practice, we have found that the latter is a no-go for proofs unless
  values are packaged with a proof that their length is equal to the index.

* `SAWCorePrelude` is generated from `Prelude.sawcore`, available in the
  `saw-core` project.

* `RocqVectorsExtra` contains facts about vectors that the Rocq standard library
  does not provide.

* `CryptolPrimitivesForSAWCore` is generated from `Cryptol.sawcore`, available
  in the `cryptol-saw-core` project.

* `SAWCorePreludeExtra` defines useful functions for
  `CryptolPrimitivesForSAWCoreExtra` to use.

* `CryptolPrimitivesForSAWCoreExtra` contains some additional useful
  definitions.


# Acknowledgements

This material is based upon work supported by the Office of Naval
Research under Contract No. N68335-17-C-0452. Any opinions, findings and
conclusions or recommendations expressed in this material are those of
the author(s) and do not necessarily reflect the views of the Office of
Naval Research.
